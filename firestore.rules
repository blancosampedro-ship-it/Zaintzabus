rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS - SISTEMA DE PERMISOS
    // ============================================
    
    // Get user's custom claims
    function getUserClaims() {
      return request.auth.token;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserClaims().rol == role;
    }
    
    // Check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserClaims().rol in roles;
    }
    
    // ============================================
    // ROLES Y PERMISOS
    // ============================================
    
    // ADMIN: Gestión completa del sistema
    function isAdmin() {
      return hasRole('admin');
    }
    
    // DFG: Consorcio/Administración Pública - SOLO LECTURA
    function isDFG() {
      return hasRole('dfg');
    }
    
    // OPERADOR: Gestión de flota y reporting
    function isOperador() {
      return hasRole('operador');
    }
    
    // JEFE_MANTENIMIENTO: Supervisión técnicos y recursos
    function isJefeMantenimiento() {
      return hasRole('jefe_mantenimiento');
    }
    
    // TECNICO: Ejecución de intervenciones
    function isTecnico() {
      return hasRole('tecnico');
    }
    
    // ============================================
    // PERMISOS POR CAPACIDAD
    // ============================================
    
    // Puede gestionar (crear, editar, asignar)
    function canManage() {
      return hasAnyRole(['admin', 'jefe_mantenimiento']);
    }
    
    // Puede ejecutar intervenciones (técnico o superior)
    function canExecuteWork() {
      return hasAnyRole(['admin', 'jefe_mantenimiento', 'tecnico']);
    }
    
    // Puede reportar incidencias (todos excepto DFG)
    function canReportIncidencias() {
      return hasAnyRole(['admin', 'jefe_mantenimiento', 'tecnico', 'operador']);
    }
    
    // Puede ver todos los tenants (DFG y admin)
    function canAccessAllTenants() {
      return hasAnyRole(['dfg', 'admin']);
    }
    
    // Puede configurar sistema (solo admin)
    function canConfigureSystem() {
      return isAdmin();
    }
    
    // ============================================
    // VALIDACIONES DE TENANT
    // ============================================
    
    // Check if user belongs to tenant
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserClaims().tenantId == tenantId;
    }
    
    // Check if user can access tenant (own tenant, DFG or admin)
    function canAccessTenant(tenantId) {
      return canAccessAllTenants() || belongsToTenant(tenantId);
    }
    
    // Puede escribir en un tenant:
    // - Usuario del propio tenant (excepto DFG que es solo lectura)
    // - Admin global puede escribir en cualquier tenant
    function canWriteToTenant(tenantId) {
      return (belongsToTenant(tenantId) && !isDFG()) || isAdmin();
    }
    
    // Validate timestamp is server timestamp
    function isServerTimestamp(field) {
      return request.resource.data[field] == request.time;
    }
    
    // ============================================
    // TENANTS COLLECTION
    // ============================================
    
    match /tenants/{tenantId} {
      // Lectura individual (get): usuarios del tenant, DFG o admin
      allow get: if canAccessTenant(tenantId);
      // Listar todos los tenants (list/query): solo admin y DFG
      // Usando comprobación directa para evitar problemas con hasAnyRole
      allow list: if isAuthenticated() && (hasRole('dfg') || hasRole('admin'));
      // Escritura: solo admin puede modificar configuración de tenant
      allow write: if canConfigureSystem();
      
      // ==========================================
      // INCIDENCIAS SUBCOLLECTION
      // Permisos: incidencias:ver, incidencias:crear, incidencias:editar, etc.
      // ==========================================
      
      match /incidencias/{incidenciaId} {
        // Read: Cualquier usuario con acceso al tenant
        allow read: if canAccessTenant(tenantId);
        
        // Create: operador, técnico, jefe o admin pueden crear (DFG NO)
        allow create: if canWriteToTenant(tenantId)
                && canReportIncidencias()
                && request.resource.data.tenantId == tenantId
                && isValidIncidenciaState(request.resource.data.estado);
        
        // Update: basado en rol y transición de estados válida
        allow update: if canWriteToTenant(tenantId)
                && canReportIncidencias()
                && request.resource.data.tenantId == tenantId
                && isValidIncidenciaState(request.resource.data.estado)
                && validStateTransition(resource.data, request.resource.data);
        
        // Delete: Solo gestores pueden eliminar (preferir soft delete)
        allow delete: if canWriteToTenant(tenantId) && canManage();
        
        function isValidIncidenciaState(estado) {
          return estado in {
            'nueva': true,
            'en_analisis': true,
            'en_intervencion': true,
            'resuelta': true,
            'cerrada': true,
            'reabierta': true
          };
        }

        // Validate canonical state transitions
        function validStateTransition(before, after) {
          let validTransitions = {
            'nueva': ['en_analisis', 'cerrada'],
            'en_analisis': ['en_intervencion', 'nueva'],
            'en_intervencion': ['resuelta', 'en_analisis'],
            'resuelta': ['cerrada', 'reabierta'],
            'cerrada': ['reabierta'],
            'reabierta': ['en_analisis']
          };

          return before.estado == after.estado ||
                 after.estado in validTransitions[before.estado];
        }
      }
      
      // ==========================================
      // INVENTARIO SUBCOLLECTION
      // Permisos: inventario:ver, inventario:crear, inventario:mover, etc.
      // ==========================================
      
      match /inventario/{itemId} {
        // Read: Cualquier usuario con acceso al tenant
        allow read: if canAccessTenant(tenantId);
        
        // Create: técnicos y gestores pueden crear items
        allow create: if canWriteToTenant(tenantId) 
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;
        
        // Update: técnicos y gestores pueden actualizar
        allow update: if canWriteToTenant(tenantId) 
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;
        
        // Delete: solo gestores pueden eliminar
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // MOVIMIENTOS INVENTARIO SUBCOLLECTION
      // tenants/{tenantId}/inventario/{itemId}/movimientos/{movId}
      // Permisos: inventario:mover, inventario:consumir
      // ==========================================

      match /inventario/{itemId}/movimientos/{movimientoId} {
        // Read: técnicos y superiores
        allow read: if canAccessTenant(tenantId) && canExecuteWork();

        // Create: técnicos pueden registrar movimientos
        allow create: if canWriteToTenant(tenantId)
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;

        // Update/Delete: movimientos son inmutables (auditoría)
        allow update, delete: if false;
      }
      
      // ==========================================
      // ACTIVOS SUBCOLLECTION
      // Permisos: activos:ver, activos:crear, activos:editar
      // ==========================================
      
      match /activos/{activoId} {
        // Read: cualquier usuario con acceso al tenant
        allow read: if canAccessTenant(tenantId);
        
        // Create: solo gestores pueden crear activos
        allow create: if canWriteToTenant(tenantId) 
                      && canManage()
                      && request.resource.data.tenantId == tenantId;
        
        // Update: técnicos pueden actualizar estado, gestores todo
        allow update: if canWriteToTenant(tenantId) 
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;
        
        // Delete: solo gestores (preferir soft delete)
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // PREVENTIVO SUBCOLLECTION
      // Permisos: preventivo:ver, preventivo:crear, preventivo:asignar
      // ==========================================

      match /preventivo/{preventivoId} {
        // Read: cualquier usuario con acceso
        allow read: if canAccessTenant(tenantId);

        // Create: solo gestores pueden crear planes preventivos
        allow create: if canWriteToTenant(tenantId)
                      && canManage()
                      && request.resource.data.tenantId == tenantId;
        
        // Update: técnicos pueden completar checklists
        allow update: if canWriteToTenant(tenantId)
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;

        // Delete: solo gestores
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // ORDENES DE TRABAJO SUBCOLLECTION
      // Permisos: ordenes_trabajo:ver, :crear, :asignar, :cerrar
      // ==========================================

      match /ordenesTrabajo/{otId} {
        // Read: cualquier usuario con acceso
        allow read: if canAccessTenant(tenantId);

        // Create: gestores pueden crear OTs
        allow create: if canWriteToTenant(tenantId)
                      && canManage()
                      && request.resource.data.tenantId == tenantId;
        
        // Update: técnicos pueden actualizar progreso y cerrar las propias
        allow update: if canWriteToTenant(tenantId)
                      && canExecuteWork()
                      && request.resource.data.tenantId == tenantId;

        // Delete: solo gestores
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // TECNICOS SUBCOLLECTION
      // Permisos: tecnicos:ver, tecnicos:asignar
      // ==========================================

      match /tecnicos/{tecnicoId} {
        // Read: gestores pueden ver técnicos
        allow read: if canAccessTenant(tenantId) && canManage();

        // Write: solo gestores
        allow write: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // USUARIOS SUBCOLLECTION
      // Permisos: usuarios:ver, usuarios:crear, usuarios:editar
      // ==========================================
      
      match /usuarios/{usuarioId} {
        // Read: usuario propio o gestores
        allow read: if canAccessTenant(tenantId) 
                    && (request.auth.uid == usuarioId || canManage());
        
        // Create: solo gestores pueden crear usuarios
        allow create: if canWriteToTenant(tenantId) && canManage();
        
        // Update: usuario propio (campos limitados) o gestores
        allow update: if canWriteToTenant(tenantId) 
                      && (request.auth.uid == usuarioId || canManage());
        
        // Delete: solo gestores
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // AUDITORIA SUBCOLLECTION
      // Permisos: solo lectura para gestores
      // ==========================================
      
      match /auditoria/{logId} {
        // Read: gestores y admin pueden ver auditoría
        allow read: if canAccessTenant(tenantId) && (canManage() || isDFG());
        
        // Create: sistema via Cloud Functions
        allow create: if canWriteToTenant(tenantId) && canExecuteWork();
        
        // Update/Delete: inmutable
        allow update, delete: if false;
      }
      
      // ==========================================
      // CONFIGURACION SUBCOLLECTION
      // Permisos: sistema:configurar
      // ==========================================
      
      match /configuracion/{configId} {
        // Read: cualquier usuario con acceso
        allow read: if canAccessTenant(tenantId);
        
        // Write: solo admin puede modificar configuración
        allow write: if canWriteToTenant(tenantId) && canConfigureSystem();
      }
      
      // ==========================================
      // SLA METRICS SUBCOLLECTION
      // Permisos: sla:ver
      // ==========================================
      
      match /sla_metrics/{metricId} {
        // Read: gestores y DFG pueden ver métricas SLA
        allow read: if canAccessTenant(tenantId);
        
        // Write: sistema via Cloud Functions
        allow create: if canWriteToTenant(tenantId) && canManage();
        allow update, delete: if false;
      }
      
      // ==========================================
      // CONTRATOS SUBCOLLECTION
      // Permisos: contratos:ver, contratos:editar
      // ==========================================

      match /contratos/{contratoId} {
        // Read: gestores y DFG pueden ver contratos
        allow read: if canAccessTenant(tenantId) && (canManage() || isDFG());
        
        // Write: solo DFG puede gestionar contratos
        allow write: if canAccessTenant(tenantId) && isDFG();
      }
      
      // ==========================================
      // ALMACENES SUBCOLLECTION
      // Permisos: almacenes:ver, almacenes:editar
      // ==========================================

      match /almacenes/{almacenId} {
        // Read: cualquier usuario con acceso
        allow read: if canAccessTenant(tenantId);
        
        // Write: gestores
        allow write: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // AUTOBUSES SUBCOLLECTION
      // Permisos: activos:ver, activos:crear, activos:editar
      // ==========================================
      
      match /autobuses/{autobusId} {
        // Read: cualquier usuario con acceso al tenant
        allow read: if canAccessTenant(tenantId);
        
        // Create: gestores pueden crear autobuses
        allow create: if canWriteToTenant(tenantId) && canManage();
        
        // Update: técnicos y gestores pueden actualizar
        allow update: if canWriteToTenant(tenantId) && canExecuteWork();
        
        // Delete: solo gestores (preferir soft delete)
        allow delete: if canWriteToTenant(tenantId) && canManage();
      }
      
      // ==========================================
      // EQUIPOS SUBCOLLECTION
      // Permisos: inventario:ver, inventario:crear, inventario:mover
      // ==========================================
      
      match /equipos/{equipoId} {
        // Read: cualquier usuario con acceso al tenant
        allow read: if canAccessTenant(tenantId);
        
        // Create: técnicos y gestores pueden crear equipos
        allow create: if canWriteToTenant(tenantId) && canExecuteWork();
        
        // Update: técnicos y gestores pueden actualizar
        allow update: if canWriteToTenant(tenantId) && canExecuteWork();
        
        // Delete: solo gestores (preferir soft delete)
        allow delete: if canWriteToTenant(tenantId) && canManage();
        
        // Movimientos de equipos
        match /movimientos/{movId} {
          allow read: if canAccessTenant(tenantId);
          allow create: if canWriteToTenant(tenantId) && canExecuteWork();
          allow update, delete: if false; // Inmutables
        }
      }
      
      // ==========================================
      // OPERADORES SUBCOLLECTION (dentro de tenant)
      // ==========================================
      
      match /operadores/{operadorId} {
        allow read: if canAccessTenant(tenantId);
        allow write: if canWriteToTenant(tenantId) && canManage();
      }
    }
    
    // ============================================
    // GLOBAL COLLECTIONS
    // ============================================
    
    // Global SLA targets and configuration
    match /sla_targets/{targetId} {
      allow read: if isAuthenticated();
      allow write: if canConfigureSystem();
    }
    
    // Global reports and analytics
    match /global_reports/{reportId} {
      allow read: if isDFG() || isAdmin();
      allow write: if false;
    }
    
    // System notifications
    match /notificaciones/{notificationId} {
      allow read: if isAuthenticated() 
                  && (resource.data.destinatarioId == request.auth.uid 
                      || resource.data.tenantId == getUserClaims().tenantId
                      || isDFG());
      allow create: if isAuthenticated() && !isDFG();
      allow update: if isAuthenticated() 
                    && !isDFG()
                    && resource.data.destinatarioId == request.auth.uid;
      allow delete: if false;
    }
    
    // ==========================================
    // CONFIGURACIÓN GLOBAL DEL SISTEMA
    // ==========================================
    
    // Ubicaciones globales (almacenes, talleres, cocheras)
    match /ubicaciones/{ubicacionId} {
      allow read: if isAuthenticated();
      allow write: if canConfigureSystem();
    }
    
    // Laboratorios de calibración
    match /laboratorios/{laboratorioId} {
      allow read: if isAuthenticated();
      allow write: if canConfigureSystem();
    }
    
    // Tipos de equipo (catálogo)
    match /tipos_equipo/{tipoId} {
      allow read: if isAuthenticated();
      allow write: if canConfigureSystem();
    }
    
    // Logs de auditoría global
    match /logs_auditoria/{logId} {
      allow read: if canManage() || isDFG();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // Configuración del sistema
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if canConfigureSystem();
    }
    
    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
